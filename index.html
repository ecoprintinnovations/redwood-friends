<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redwood Friends</title>
  <style>
    html, body { height: 100%; margin: 0; background:#1c2a1e; }
    #game { width: 100%; height: 100%; }
    .hud { position: absolute; left: 12px; top: 12px; z-index: 10; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,.4); }
    .hud .badge { display:inline-block; margin-right:6px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2); font-size:12px; }
    .hint { position:absolute; right:12px; bottom:12px; color:#fff; opacity:.85; font-size:12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .overlay { position: absolute; inset: 0; display:none; place-items:center; background: rgba(10,16,12,.65); z-index: 20; }
    .card { background: #112015; color: #f3fff5; padding: 20px 18px; border-radius: 16px; width: min(520px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.08); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card h2 { margin: 0 0 8px 0; font-weight: 700; font-size: 22px; }
    .card p { margin: 4px 0 0 0; line-height: 1.45; font-size: 14px; opacity:.95; }
    .card .btns { margin-top: 14px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn { background:#3fbf7f; color:#082014; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; }
    .btn.secondary { background: transparent; color:#c9f7d8; border:1px solid rgba(255,255,255,.18);}    
  </style>
  <!-- Phaser 3 via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
</head>
<body>
  <div id="game"></div>
  <div class="hud">
    <div id="badges"></div>
  </div>
  <div class="hint">Move: WASD / Arrow Keys · Jump: Space · Interact: E</div>

  <!-- Overlays for mini-challenges -->
  <div class="overlay" id="overlay">
    <div class="card">
      <h2 id="ov-title">Challenge</h2>
      <p id="ov-text">Complete the task to make a new friend.</p>
      <div class="btns">
        <button class="btn" id="ov-start">Start</button>
        <button class="btn secondary" id="ov-close">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Simple helper to add a badge chip to HUD
    const badgeEl = document.getElementById('badges');
    function addBadge(label) {
      const span = document.createElement('span');
      span.className = 'badge';
      span.textContent = label;
      badgeEl.appendChild(span);
    }

    // Overlay logic for readable prompts
    const overlay = document.getElementById('overlay');
    const ovTitle = document.getElementById('ov-title');
    const ovText = document.getElementById('ov-text');
    const ovStart = document.getElementById('ov-start');
    const ovClose = document.getElementById('ov-close');

    function showOverlay(title, text, onStart) {
      ovTitle.textContent = title;
      ovText.textContent = text;
      overlay.style.display = 'grid';
      const startHandler = () => { overlay.style.display = 'none'; onStart && onStart(); cleanup(); };
      const closeHandler = () => { overlay.style.display = 'none'; cleanup(); };
      function cleanup(){ ovStart.removeEventListener('click', startHandler); ovClose.removeEventListener('click', closeHandler); }
      ovStart.addEventListener('click', startHandler);
      ovClose.addEventListener('click', closeHandler);
    }

    // Game setup using Phaser (no external assets; everything is drawn procedurally)
    const config = {
      type: Phaser.AUTO,
      parent: 'game',
      width: 1024,
      height: 576,
      backgroundColor: '#204026',
      physics: { default: 'arcade', arcade: { gravity: { y: 1200 }, debug: false }},
      scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
      scene: { preload, create, update }
    };

    const game = new Phaser.Game(config);

    let cursors, keyE;
    let player;
    let platforms;
    let friends;
    let collectibles;
    let movingPads;
    let canDoubleJump = false;
    let jumps = 0;

    function preload(){
      // Make simple textures with Graphics so we don't need files
      this.tx = (key, w, h, colour) => {
        const g = this.add.graphics();
        g.fillStyle(colour, 1);
        g.fillRoundedRect(0, 0, w, h, 6);
        g.generateTexture(key, w, h);
        g.destroy();
      };
      this.tx('player', 28, 34, 0xF6C8C8);
      this.tx('platform', 160, 24, 0x5A3A23);
      this.tx('moss', 160, 10, 0x2E6C3F);
      this.tx('friendBlue', 30, 30, 0x3aa7ff);
      this.tx('friendGreen', 30, 30, 0x46e07c);
      this.tx('collect', 16, 16, 0xFFD05A);
      this.tx('lilypad', 110, 20, 0x60c08a);
      this.tx('water', 1024, 60, 0x205a7a);
      this.tx('log', 120, 22, 0x7b4a2b);
    }

    function makeTreeBackground(scene){
      const w = scene.scale.width; const h = scene.scale.height;
      const bg = scene.add.graphics();
      bg.fillStyle(0x17331f,1); bg.fillRect(0,0,w,h);
      // Parallax layers of trunks + canopy blobs
      const trunks = scene.add.graphics(); trunks.fillStyle(0x3b2516,.9);
      for(let i=0;i<8;i++){
        const x = i * (w/7) + Phaser.Math.Between(-20,20);
        trunks.fillRect(x, 120, 24, h);
      }
      const canopy = scene.add.graphics(); canopy.fillStyle(0x245d37,1);
      for(let i=0;i<9;i++){
        const x = i * (w/8) + Phaser.Math.Between(-10,10);
        canopy.fillEllipse(x, 110, 220, 90);
      }
    }

    function create(){
      makeTreeBackground(this);

      // Static ground & platforms
      platforms = this.physics.add.staticGroup();
      const ground = platforms.create(512, 560, 'platform').setScale(6.4, 1.2).refreshBody();
      this.add.image(512, 534, 'moss').setScale(6.4,1);

      // A few staggered platforms
      [
        [220, 460], [420, 404], [640, 356], [860, 318],
        [160, 320], [320, 280], [520, 240]
      ].forEach(([x,y])=>{
        const p = platforms.create(x, y, 'platform');
        this.add.image(x, y-12, 'moss');
        p.refreshBody();
      });

      // Water area for lily pad challenge
      const water = this.add.image(770, 540, 'water').setOrigin(.5,1);

      // Player
      player = this.physics.add.sprite(120, 520, 'player');
      player.setCollideWorldBounds(true);
      player.body.setSize(20, 30).setOffset(4,4);

      this.physics.add.collider(player, platforms);

      // Controls
      cursors = this.input.keyboard.createCursorKeys();
      keyE = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E);
      this.input.keyboard.addKeys('W,A,S,D');

      // Friends
      friends = this.physics.add.staticGroup();
      const blueJay = friends.create(520, 210, 'friendBlue').setData('id', 'tiko');
      blueJay.setData('title','Tiko the Blue Jay');
      blueJay.setData('text','Help Tiko find three flute pieces across the canopy platforms.');

      const frog = friends.create(900, 288, 'friendGreen').setData('id', 'mossy');
      frog.setData('title','Mossy the Frog');
      frog.setData('text','Cross the wobbly lily pads without falling in the water.');

      this.physics.add.overlap(player, friends, (pl, fr) => {
        if (Phaser.Input.Keyboard.JustDown(keyE)) {
          startFriendChallenge.call(this, fr);
        } else {
          showFloatingText(this, fr.x, fr.y-28, 'Press E to help');
        }
      });

      // Groups used by challenges
      collectibles = this.physics.add.group();
      movingPads = this.physics.add.group({ allowGravity:false, immovable:true });

      // Jump handling (with optional double jump after first badge)
      this.input.keyboard.on('keydown-SPACE', () => {
        const onFloor = player.body.blocked.down;
        if (onFloor) { player.setVelocityY(-480); jumps = 1; }
        else if (canDoubleJump && jumps < 2) { player.setVelocityY(-420); jumps++; }
      });

      this.physics.world.on('worldbounds', () => {
        // Not used, but kept for potential future bounds logic
      });
    }

    function update(){
      const left = cursors.left.isDown || this.input.keyboard.addKey('A').isDown;
      const right = cursors.right.isDown || this.input.keyboard.addKey('D').isDown;
      const onFloor = player.body.blocked.down;

      if(left) player.setVelocityX(-220);
      else if(right) player.setVelocityX(220);
      else player.setVelocityX(0);

      if(onFloor) jumps = 0;

      // Simple lily pad motion
      movingPads.children.iterate(p => {
        if(!p) return;
        p.x += p.getData('dx') || 0;
        if(p.x < p.getData('minX') || p.x > p.getData('maxX')) {
          p.setData('dx', -(p.getData('dx')));
        }
      });
    }

    // Utility: floating helper text that fades out
    function showFloatingText(scene, x, y, text){
      const t = scene.add.text(x, y, text, { fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif', fontSize:12, color:'#ffffff' }).setOrigin(.5,1);
      scene.tweens.add({ targets:t, y: y-16, alpha:0, duration:800, onComplete: () => t.destroy() });
    }

    // Start a challenge based on friend id
    function startFriendChallenge(friend){
      const id = friend.getData('id');
      if(id === 'tiko') startCollectChallenge.call(this, friend);
      if(id === 'mossy') startLilyPadChallenge.call(this, friend);
    }

    // Challenge 1: Collect 3 flute pieces on canopy
    function startCollectChallenge(friend){
      showOverlay(friend.getData('title'), friend.getData('text'), () => {
        // Clear any old stuff
        collectibles.clear(true, true);
        movingPads.clear(true, true);
        // Place three collectibles on upper platforms
        const spots = [ [520, 210-40], [320, 268-40], [640, 344-40] ];
        spots.forEach(([x,y]) => {
          const c = collectibles.create(x, y, 'collect');
          c.setData('type','flute');
          c.body.setAllowGravity(false);
          c.setBounce(0.2);
          c.setCircle(8,0,0);
        });
        const pickup = (pl, item) => {
          item.destroy();
          const left = collectibles.countActive();
          showFloatingText(this, item.x, item.y-10, left+" left");
          if(left === 0){
            this.physics.world.removeCollider(collider);
            addBadge('Tiko – Music Buddy');
            canDoubleJump = true; // Reward: double jump unlocked
            showOverlay('Tiko is your friend!', 'You found all three flute pieces. Double jump unlocked. Try Space in mid-air.', null);
          }
        };
        const collider = this.physics.add.overlap(player, collectibles, pickup, null, this);
      });
    }

    // Challenge 2: Cross moving lily pads
    function startLilyPadChallenge(friend){
      showOverlay(friend.getData('title'), friend.getData('text'), () => {
        // Clear previous objects
        collectibles.clear(true, true);
        movingPads.clear(true, true);

        // Build 4 moving pads over the water towards a goal log
        const pads = [ [700, 500, 640, 760], [820, 480, 760, 880], [940, 460, 900, 990], [1060, 440, 1020, 1100] ];
        pads.forEach(([x,y,minX,maxX], i) => {
          const p = movingPads.create(x, y, 'lilypad').setImmovable(true);
          p.setData('dx', i % 2 === 0 ? -1.2 : 1.2);
          p.setData('minX', minX);
          p.setData('maxX', maxX);
          p.body.setAllowGravity(false);
        });

        const goal = this.physics.add.staticImage(1160, 420, 'log');

        const padCollider = this.physics.add.collider(player, movingPads);
        const goalOverlap = this.physics.add.overlap(player, goal, () => {
          this.physics.world.removeCollider(padCollider);
          this.physics.world.removeCollider(goalOverlap);
          addBadge('Mossy – Pond Pal');
          showOverlay('Mossy is your friend!', 'Lovely jumps. The pond party is on!', null);
        });

        // If player falls into water, gently reset
        const resetIfFall = this.time.addEvent({ delay: 200, loop: true, callback: () => {
          if(player.y > 560){ player.setPosition(860, 300); player.setVelocity(0,0); }
        }});

        // Give the player a reasonable starting spot
        player.setPosition(680, 320);
      });
    }
  </script>
</body>
</html>
