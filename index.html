<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redwood Friends</title>
  <style>
    html, body { height: 100%; margin: 0; background:#142318; }
    #game { width: 100%; height: 100%; }
    .hud { position: absolute; left: 12px; top: 12px; z-index: 10; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,.4); }
    .hud .badge { display:inline-block; margin-right:6px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2); font-size:12px; }
    .hint { position:absolute; right:12px; bottom:12px; color:#fff; opacity:.85; font-size:12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .overlay { position: absolute; inset: 0; display:none; place-items:center; background: rgba(10,16,12,.65); z-index: 20; }
    .card { background: #112015; color: #f3fff5; padding: 20px 18px; border-radius: 16px; width: min(560px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.08); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card h2 { margin: 0 0 8px 0; font-weight: 700; font-size: 22px; }
    .card p { margin: 4px 0 0 0; line-height: 1.45; font-size: 14px; opacity:.95; }
    .card .btns { margin-top: 14px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn { background:#3fbf7f; color:#082014; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; }
    .btn.secondary { background: transparent; color:#c9f7d8; border:1px solid rgba(255,255,255,.18);}    
  </style>
  <!-- Phaser 3 via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
</head>
<body>
  <div id="game"></div>
  <div class="hud">
    <div id="badges"></div>
  </div>
  <div class="hint">Move: WASD / Arrow Keys · Jump: Space (double after Tiko) · Interact: E</div>

  <!-- Overlays for mini-challenges -->
  <div class="overlay" id="overlay">
    <div class="card">
      <h2 id="ov-title">Challenge</h2>
      <p id="ov-text">Complete the task to make a new friend.</p>
      <div class="btns">
        <button class="btn" id="ov-start">Start</button>
        <button class="btn secondary" id="ov-close">Close</button>
      </div>
    </div>
  </div>

  <script>
    // HUD badges
    const badgeEl = document.getElementById('badges');
    function addBadge(label) {
      const span = document.createElement('span');
      span.className = 'badge';
      span.textContent = label;
      badgeEl.appendChild(span);
    }

    // Overlay helpers
    const overlay = document.getElementById('overlay');
    const ovTitle = document.getElementById('ov-title');
    const ovText = document.getElementById('ov-text');
    const ovStart = document.getElementById('ov-start');
    const ovClose = document.getElementById('ov-close');

    function showOverlay(title, text, onStart) {
      ovTitle.textContent = title;
      ovText.textContent = text;
      overlay.style.display = 'grid';
      const startHandler = () => { overlay.style.display = 'none'; onStart && onStart(); cleanup(); };
      const closeHandler = () => { overlay.style.display = 'none'; cleanup(); };
      function cleanup(){ ovStart.removeEventListener('click', startHandler); ovClose.removeEventListener('click', closeHandler); }
      ovStart.addEventListener('click', startHandler);
      ovClose.addEventListener('click', closeHandler);
    }

    // Phaser game
    const config = {
      type: Phaser.AUTO,
      parent: 'game',
      width: 1024,
      height: 576,
      backgroundColor: '#1a3321',
      physics: { default: 'arcade', arcade: { gravity: { y: 980 }, debug: false }}, // tuned gravity
      scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
      scene: { preload, create, update }
    };

    const game = new Phaser.Game(config);

    let cursors, keyE;
    let player;
    let platforms;
    let friends;
    let collectibles;
    let movingPads;
    let gardenRocks;
    let canDoubleJump = false;
    let jumps = 0;

    // Jump assistance ("coyote time" and a short jump buffer)
    let lastOnGroundTime = 0;
    let jumpPressedTime = -9999;
    const COYOTE_MS = 120;
    const BUFFER_MS = 140;

    function preload(){
      // Utility to draw and generate textures
      const drawTex = (key, draw) => { const g = this.add.graphics(); draw(g); g.generateTexture(key); g.destroy(); };

      // Pretty blocks (pink/green/blue) with light hatch
      const makeBlock = (key, w, h, base, accent) => drawTex(key, g => {
        g.clear(); g.fillStyle(base,1); g.fillRoundedRect(0,0,w,h,6);
        g.lineStyle(1, accent, 0.22);
        for(let x=-h; x<w; x+=10){ g.lineBetween(x, h, x+h, 0); }
        g.fillStyle(accent, 0.22); g.fillRoundedRect(0,0,w,6,6);
      });
      makeBlock('blockPink', 160, 24, 0xF5A3C7, 0xFFFFFF);
      makeBlock('blockGreen',160, 24, 0x77D09C, 0xFFFFFF);
      makeBlock('blockBlue', 160, 24, 0x7EC1FF, 0xFFFFFF);

      // Moss strip, water, log, rock
      drawTex('moss', g => { g.fillStyle(0x2c6c44,1); g.fillRoundedRect(0,0,160,10,6); });
      drawTex('water', g => { g.fillStyle(0x205a7a,1); g.fillRect(0,0,1024,60); });
      drawTex('log', g => { g.fillStyle(0x7b4a2b,1); g.fillRoundedRect(0,0,120,22,6); });
      drawTex('rock', g => { g.fillStyle(0x7f8b9b,1); g.fillRoundedRect(0,0,70,18,6); });
      drawTex('mushroom', g => { g.fillStyle(0xb43a53,1); g.fillEllipse(0+22,0+12,44,20); g.fillStyle(0xf2eada,1); g.fillRoundedRect(10,18,24,10,4); });

      // Player
      drawTex('player', g => { g.fillStyle(0xF6C8C8,1); g.fillRoundedRect(0,0,28,34,8); g.lineStyle(2,0xffffff,0.2); g.strokeRoundedRect(1,1,26,32,8); });
      drawTex('collect', g => { g.fillStyle(0xFFD05A,1); g.fillCircle(8,8,8); });

      // Friends with more natural shapes (procedural "illustrated" look)
      // Blue Jay (body + crest + beak + wing)
      drawTex('friendBlueJay', g => {
        g.fillStyle(0x2c79ff,1); g.fillEllipse(26,20,36,28); // body
        g.fillStyle(0x1a59c8,1); g.........................................illTriangle(40,18, 52,20, 40,22); // beak
        g.fillStyle(0x9dd0ff,1); g.fillEllipse(22,22,18,12); // wing
        g.fillStyle(0xffffff,1); g.fillCircle(20,16,3); g.fillStyle(0x000000,1); g.fillCircle(20,16,1.5);
      });
      // Frog (body + eyes)
      drawTex('friendFrog', g => {
        g.fillStyle(0x49c06a,1); g.fillEllipse(24,22,40,24); // body
        g.fillStyle(0x3aa65a,1); g.fillEllipse(24,28,30,12); // belly shade
        g.fillStyle(0xffffff,1); g.fillCircle(14,14,4); g.fillCircle(34,14,4);
        g.fillStyle(0x000000,1); g.fillCircle(14,14,2); g.fillCircle(34,14,2);
      });
      // Fox (body + ears + tail + face)
      drawTex('friendFox', g => {
        g.fillStyle(0xf08c2e,1); g.fillEllipse(26,22,36,26); // body
        g.fillTriangle(16,6, 22,2, 20,12); g.fillTriangle(30,6, 36,2, 32,12); // ears
        g.fillStyle(0xffd7b3,1); g.fillEllipse(26,24,20,16); // face/cheeks
        g.fillStyle(0xf08c2e,1); g.fillEllipse(44,26,18,12); // tail
        g.fillStyle(0xffffff,1); g.fillEllipse(48,26,10,8); // tail tip
        g.fillStyle(0x000000,1); g.fillCircle(22,20,1.5); g.fillCircle(30,20,1.5);
      });
      // Crab (body + claws + legs)
      drawTex('friendCrab', g => {
        g.fillStyle(0xee4455,1); g.fillEllipse(26,24,34,18); // body
        g.fillStyle(0xee4455,1); g.fillTriangle(10,18, 2,10, 6,22); g.fillTriangle(42,18, 50,10, 46,22); // claws
        g.lineStyle(2,0xee4455,1);
        for(let i=0;i<3;i++){ g.lineBetween(14+i*6,32, 12+i*6,38); g.lineBetween(28+i*6,32, 26+i*6,38); }
        g.fillStyle(0xffffff,1); g.fillCircle(18,16,2.5); g.fillCircle(34,16,2.5);
        g.fillStyle(0x000000,1); g.fillCircle(18,16,1); g.fillCircle(34,16,1);
      });

      // Lilypad
      drawTex('lilypad', g => { g.fillStyle(0x60c08a,1); g.fillRoundedRect(0,0,110,20,10); g.lineStyle(2,0x3f8c66,0.6); g.strokeRoundedRect(1,1,108,18,10); });
    }

    function makeTreeBackground(scene){
      const w = scene.scale.width; const h = scene.scale.height;
      const bg = scene.add.graphics();
      bg.fillStyle(0x17331f,1); bg.fillRect(0,0,w,h);
      // trunks
      const trunks = scene.add.graphics(); trunks.fillStyle(0x3b2516,.9);
      for(let i=0;i<8;i++){
        const x = i * (w/7) + Phaser.Math.Between(-20,20);
        trunks.fillRect(x, 120, 24, h);
      }
      const canopy = scene.add.graphics(); canopy.fillStyle(0x245d37,1);
      for(let i=0;i<9;i++){
        const x = i * (w/8) + Phaser.Math.Between(-10,10);
        canopy.fillEllipse(x, 110, 220, 90);
      }
    }

    function create(){
      makeTreeBackground(this);

      // Static platforms (revised: easier first climb + reachable second level)
      platforms = this.physics.add.staticGroup();
      // ground
      platforms.create(512, 560, 'blockPink').setScale(6.4, 1.2).refreshBody();
      this.add.image(512, 534, 'moss').setScale(6.4,1);

      // step-up path to canopy (lowered by ~20px overall)
      const layout = [
        {x: 180, y: 505, key:'blockGreen'},
        {x: 330, y: 475, key:'blockBlue'},
        {x: 480, y: 448, key:'blockPink'},
        {x: 620, y: 423, key:'blockGreen'},
        {x: 780, y: 398, key:'blockBlue'},
        // canopy row now slightly lower to guarantee reach
        {x: 220, y: 330, key:'blockPink'},
        {x: 380, y: 300, key:'blockGreen'},
        {x: 560, y: 270, key:'blockBlue'}
      ];
      layout.forEach(p => platforms.create(p.x, p.y, p.key).refreshBody());

      // helper mushroom spring near the tricky step (press jump on it to boost)
      const mushroom = this.physics.add.staticImage(445, 500, 'mushroom');

      // ponds
      this.add.image(770, 540, 'water').setOrigin(.5,1);
      this.add.image(220, 540, 'water').setOrigin(.5,1);

      // Player
      player = this.physics.add.sprite(120, 520, 'player');
      player.setCollideWorldBounds(true);
      player.body.setSize(20, 30).setOffset(4,4);
      this.physics.add.collider(player, platforms);

      // Mushroom bounce
      this.physics.add.overlap(player, mushroom, () => {
        if(Phaser.Input.Keyboard.DownDuration(this.input.keyboard.addKey('SPACE'), 200)){
          player.setVelocityY(-560); // strong pop
        }
      });

      // Controls
      cursors = this.input.keyboard.createCursorKeys();
      keyE = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E);
      this.input.keyboard.addKeys('W,A,S,D');

      // Friends (now with illustrated sprites)
      friends = this.physics.add.staticGroup();
      const blueJay = friends.create(560, 238, 'friendBlueJay').setData('id', 'tiko');
      blueJay.setData('title','Tiko the Blue Jay');
      blueJay.setData('text','Find three flute pieces across the canopy. Reward: double jump.');

      const frog = friends.create(900, 368, 'friendFrog').setData('id', 'mossy');
      frog.setData('title','Mossy the Frog');
      frog.setData('text','Cross the wobbly lily pads without falling in.');

      const fox = friends.create(380, 270, 'friendFox').setData('id', 'amber');
      fox.setData('title','Amber the Fox');
      fox.setData('text','Help Amber gather berries for the garden. Collect three berries.');

      const crab = friends.create(180, 488, 'friendCrab').setData('id', 'pinch');
      crab.setData('title','Pinch the Crab');
      crab.setData('text','Hop across river rocks to reach Pinch\'s shell.');

      this.physics.add.overlap(player, friends, (pl, fr) => {
        if (Phaser.Input.Keyboard.JustDown(keyE)) startFriendChallenge.call(this, fr);
        else showFloatingText(this, fr.x, fr.y-34, 'Press E to help');
      });

      // Challenge groups
      collectibles = this.physics.add.group();
      movingPads = this.physics.add.group({ allowGravity:false, immovable:true });
      gardenRocks = this.physics.add.group({ allowGravity:false, immovable:true });

      // Jump handling with double jump + coyote time + buffer
      this.input.keyboard.on('keydown-SPACE', () => { jumpPressedTime = this.time.now; tryJump.call(this); });
    }

    function tryJump(){
      const onGround = player.body.blocked.down;
      if(onGround) lastOnGroundTime = this.time.now;

      // Allow jump if on ground, or within coyote window, or buffered shortly before landing
      const canGroundJump = onGround || (this.time.now - lastOnGroundTime) < COYOTE_MS;
      const buffered = (this.time.now - jumpPressedTime) < BUFFER_MS;

      if(canGroundJump && buffered){ player.setVelocityY(-520); jumps = 1; return; }
      if(!onGround && canDoubleJump && jumps < 2 && buffered){ player.setVelocityY(-460); jumps++; return; }
    }

    function update(){
      const left = cursors.left.isDown || this.input.keyboard.addKey('A').isDown;
      const right = cursors.right.isDown || this.input.keyboard.addKey('D').isDown;
      const onFloor = player.body.blocked.down;

      if(left) player.setVelocityX(-225);
      else if(right) player.setVelocityX(225);
      else player.setVelocityX(0);

      if(onFloor){ jumps = 0; lastOnGroundTime = this.time.now; }

      // Move pads (pond)
      movingPads.children.iterate(p => {
        if(!p) return;
        p.x += p.getData('dx') || 0;
        if(p.x < p.getData('minX') || p.x > p.getData('maxX')) p.setData('dx', -(p.getData('dx')));
      });

      // Gentle rock bob for the crab path
      gardenRocks.children.iterate(r => { if(!r) return; r.y += Math.sin(performance.now()/400 + r.x)*0.05; });
    }

    // Utility: fading helper text
    function showFloatingText(scene, x, y, text){
      const t = scene.add.text(x, y, text, { fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif', fontSize:12, color:'#ffffff' }).setOrigin(.5,1);
      scene.tweens.add({ targets:t, y: y-16, alpha:0, duration:800, onComplete: () => t.destroy() });
    }

    // Friend router
    function startFriendChallenge(friend){
      const id = friend.getData('id');
      if(id === 'tiko') startCollectChallenge.call(this, friend);
      if(id === 'mossy') startLilyPadChallenge.call(this, friend);
      if(id === 'amber') startBerryChallenge.call(this, friend);
      if(id === 'pinch') startCrabRocksChallenge.call(this, friend);
    }

    // Tiko: collect 3 items in canopy
    function startCollectChallenge(friend){
      showOverlay(friend.getData('title'), friend.getData('text'), () => {
        collectibles.clear(true, true); movingPads.clear(true, true); gardenRocks.clear(true, true);
        const spots = [ [560, 238-44], [380, 300-44], [220, 330-44] ];
        spots.forEach(([x,y]) => { const it = collectibles.create(x, y, 'collect'); it.body.setAllowGravity(false); it.setData('type','flute'); });
        const pickup = (pl, it) => {
          it.destroy(); const left = collectibles.countActive(); showFloatingText(this, it.x, it.y-10, left+" left");
          if(left === 0){ this.physics.world.removeCollider(collider); addBadge('Tiko – Music Buddy'); canDoubleJump = true;
            showOverlay('Tiko is your friend!', 'You found all the flute pieces. Double jump is now unlocked!', null); }
        };
        const collider = this.physics.add.overlap(player, collectibles, pickup, null, this);
      });
    }

    // Mossy: moving lily pads across pond
    function startLilyPadChallenge(friend){
      showOverlay(friend.getData('title'), friend.getData('text'), () => {
        collectibles.clear(true, true); movingPads.clear(true, true); gardenRocks.clear(true, true);
        const pads = [ [700, 500, 640, 760], [820, 480, 760, 880], [940, 460, 900, 990], [1060, 440, 1020, 1100] ];
        pads.forEach(([x,y,minX,maxX], i) => { const p = movingPads.create(x, y, 'lilypad').setImmovable(true); p.setData('dx', i % 2 === 0 ? -1.05 : 1.05); p.setData('minX', minX); p.setData('maxX', maxX); p.body.setAllowGravity(false); });
        const goal = this.physics.add.staticImage(1160, 420, 'log');
        const padCollider = this.physics.add.collider(player, movingPads);
        const goalOverlap = this.physics.add.overlap(player, goal, () => {
          this.physics.world.removeCollider(padCollider); this.physics.world.removeCollider(goalOverlap);
          addBadge('Mossy – Pond Pal'); showOverlay('Mossy is your friend!', 'Lovely jumps. The pond party is on!', null);
        });
        // reset if fall
        this.time.addEvent({ delay: 200, loop: true, callback: () => { if(player.y > 560){ player.setPosition(680, 320); player.setVelocity(0,0); }}});
        player.setPosition(680, 320);
      });
    }

    // Amber the Fox: collect berries on mid platforms
    function startBerryChallenge(friend){
      showOverlay(friend.getData('title'), friend.getData('text'), () => {
        collectibles.clear(true, true); movingPads.clear(true, true); gardenRocks.clear(true, true);
        const berrySpots = [ [330, 475-40], [480, 448-40], [620, 423-40] ];
        berrySpots.forEach(([x,y]) => { const b = collectibles.create(x, y, 'collect'); b.body.setAllowGravity(false); });
        const pickup = (pl, it) => {
          it.destroy(); const left = collectibles.countActive(); showFloatingText(this, it.x, it.y-10, left+" left");
          if(left === 0){ this.physics.world.removeCollider(col); addBadge('Amber – Garden Helper'); showOverlay('Amber is your friend!', 'Berries gathered. The garden will thrive!', null); }
        };
        const col = this.physics.add.overlap(player, collectibles, pickup, null, this);
        player.setPosition(300, 520);
      });
    }

    // Pinch the Crab: hop across bobbing rocks to the shell
    function startCrabRocksChallenge(friend){
      showOverlay(friend.getData('title'), friend.getData('text'), () => {
        collectibles.clear(true, true); movingPads.clear(true, true); gardenRocks.clear(true, true);
        const rocks = [ [140, 520], [200, 502], [260, 488], [320, 476], [380, 466] ];
        rocks.forEach(([x,y]) => { const r = gardenRocks.create(x, y, 'rock'); r.body.setAllowGravity(false); r.setImmovable(true); });
        const shell = this.physics.add.staticImage(430, 452, 'log');
        const rockCol = this.physics.add.collider(player, gardenRocks);
        const shellOv = this.physics.add.overlap(player, shell, () => {
          this.physics.world.removeCollider(rockCol); this.physics.world.removeCollider(shellOv);
          addBadge('Pinch – River Buddy'); showOverlay('Pinch is your friend!', 'You made it over the rocks to the shiny shell!', null);
        });
        this.time.addEvent({ delay: 200, loop: true, callback: () => { if(player.y > 560){ player.setPosition(120, 520); player.setVelocity(0,0); }}});
        player.setPosition(120, 520);
      });
    }
  </script>
</body>
</html>
